{
  auto_https off
  admin off
}

(auth) {
    forward_auth host-gw:4180 {
        uri /oauth2/auth

        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-Host {host}

        copy_headers \
            X-Auth-Request-User \
            X-Auth-Request-Email \
            X-Auth-Request-Groups \
            X-Auth-Request-Access-Token \
            Authorization

        @unauthenticated status 401
        handle_response @unauthenticated {
            redir * http://sso.celine.localhost/oauth2/sign_in?rd={scheme}://{hostport}{uri}
        }
    }
}

http://superset.celine.localhost {
    import auth
    reverse_proxy host-gw:8088
}

http://jupyter.celine.localhost {
    import auth
    reverse_proxy host-gw:8888
}

http://keycloak.celine.localhost {
  reverse_proxy host-gw:8080
}

http://sso.celine.localhost {
  reverse_proxy host-gw:4180
}

http://mqtt.celine.localhost {
  reverse_proxy host-gw:1884
}

# Pipelines
http://marquez.celine.localhost {
  import auth
  reverse_proxy host-gw:5002
}

http://prefect.celine.localhost {
  import auth
  reverse_proxy host-gw:4200
}

# UIs
http://assistant.celine.localhost {
  import auth

  handle_path /api/* {
    reverse_proxy host-gw:8012
  }

  reverse_proxy host-gw:3003
}

http://webapp.celine.localhost {
  import auth
  handle_path /api/assistant/* {
    reverse_proxy host-gw:8012
  }
  reverse_proxy /api* host-gw:8014
  reverse_proxy host-gw:3005
}


# APIs
http://api.celine.localhost {
 
  handle_path /datasets* {
    reverse_proxy host-gw:8001
  }

  handle_path /dt* {
    reverse_proxy host-gw:8002
  }

  handle_path /rec-registry* {
    reverse_proxy host-gw:8004
  }

  handle_path /mqtt* {
    reverse_proxy host-gw:8009
  }

  handle_path /webapp* {
    reverse_proxy host-gw:8014
  }

  handle_path /assistant* {
    reverse_proxy host-gw:8012
  }

  handle_path /nudging* {
    reverse_proxy host-gw:8016
  }
}
